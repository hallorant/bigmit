  org $5200
import '../lib/barden_fill.asm'
import 'timer.asm'
import 'screen.asm'

; |   |               |             |    --.--
; |---|,---..   .,---.|--- ,---.,---|      |  ,---.. . .,---.,---.
; |   |,---||   ||   ||    |---'|   |      |  |   || | ||---'|
; `   '`---^`---'`   '`---'`---'`---'      `  `---'`-'-'`---'`

stack_space	defs	100
stack		equ	$-1

img32  		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$ff,$ff,$ff,$ff,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$ff, $ff,$ff,$ff,$00,$00,$00,$00,$00,$ff,$ff, $ff,$ff,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$ff,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$ff,$ff,$ff,$00,$00
   		defb	$00,$00,$00,$00,$00,$ff,$ff,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$ff,$ff
   		defb	$00,$00,$ff,$ff,$ff,$00,$ff,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$ff, $00,$00,$00,$00,$00,$00,$00
   		defb	$ff,$ff,$00,$00,$00,$ff,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$ff,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$ff,$00,$ff,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$ff,$00,$00,$ff, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$ff,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$ff,$ff,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$ff,$ff,$00,$00,$00,$00, $ff,$ff,$ff,$ff,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$ff,$ff,$00,$ff, $00,$00,$00,$00,$ff,$ff,$ff
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00,$ff,$ff,$ff, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$ff,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$00,$ff,$ff,$ff, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$00,$ff,$00,$00,$ff, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$00,$00,$ff,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$00,$00, $00,$00,$00,$ff,$ff,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$ff,$ff,$ff,$ff,$00,$00,$00,$ff,$00,$00, $00,$ff,$ff,$00,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$ff,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00,$00,$00,$00, $ff,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$ff,$ff,$00,$00,$ff, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$ff,$ff,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$ff,$ff,$ff
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$ff, $ff,$ff,$ff,$00,$00,$00,$00,$00,$00,$00, $ff,$ff,$ff,$ff,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$ff,$ff,$ff,$ff,$ff,$ff,$ff, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
   		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00

pat32  		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff
		defb	$00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00,$ff,$00,$ff, $00,$ff,$00,$ff,$00,$ff,$00
		defb	$ff,$00,$00,$00,$ff,$00,$00,$00,$ff,$00, $00,$00,$ff,$00,$00,$00,$ff,$00,$00,$00, $ff,$00,$00,$00,$ff,$00,$00
		defb	$00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00,$00,$00,$00, $00,$00,$00,$00,$00,$00,$00
		defb	$ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff, $ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff,$ff, $ff,$ff,$ff,$ff,$ff,$ff,$ff

img_col		defb	0

; Scroll the graphics buffer to the right one pixel.
scroll_gb_right_one_pixel macro
  ld hl,gb+gb_size-1-gb_width
  ld de,gb+gb_size-1
  ld bc,gb_size-gb_width
  lddr
  endm

animate_img_to_gb macro
  scroll_gb_right_one_pixel
  ld hl,img32
  ; Deterine which column of the image to add
  ld c,$1f ; 0001_1111 (mask)
  ld a,(img_col)
  inc a
  and c
  ld (img_col),a
  or a ; is a == 0?
  jr z,_img_col_draw

  ld b,a ; columns over
  ld de,gb_width
_img_ptr_loop:
  add hl,de
  djnz _img_ptr_loop
_img_col_draw:
  ld de,gb
  ld bc,gb_width
  ldir
  endm

main:
  ld sp,stack

  setup_timer

prep_screen:
  ; Clear the graphics buffer
  ld d,$00
  ld hl,gb
  ld bc,gb_size
  call barden_fill

  ; Clear the back buffer
  ld d,$80
  ld hl,bb
  ld bc,bb_size
  call barden_fill

  ; Clear the screen
  ld d,$80
  ld hl,screen
  ld bc,row*16
  call barden_fill

  ld a,'>'
  ld (screen+row*3),a

  ; Frame the raycasting window on the screen.
  ld ix,window-row-1
  ld iy,window-row-1+row*(window_height+1)
  ld b,window_width+2
hline_loop:
  ld (ix),$b0 ; top horizontal line
  ld (iy),$83 ; bottom horizontal line
  inc ix
  inc iy
  djnz hline_loop

  ld ix,window-1
  ld iy,window-1+window_width+1
  ld de,row
  ld b,window_height
vline_loop:
  ld (ix),$bb   ; left vertical line
  ld (iy),$b7   ; right vertical line
  add ix,de
  add iy,de
  djnz vline_loop
  
  ; ---------------------
  ; ----- GAME LOOP -----
  ; ---------------------
game_loop:
  animate_img_to_gb
  draw_gb_to_bb

  await_vblank
  draw_bb_to_screen

  jp game_loop
  end main
